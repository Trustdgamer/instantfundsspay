<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard - InstantFundsPay</title>
  <style>
   * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg1: #141e30; --bg2: #243b55; --glass: rgba(255,255,255,0.08);
      --text: #f5f5f5; --accent: #ffd369; --btn1: #4facfe; --btn2: #00f2fe;
      --ok: #2ed573; --warn: #ffb020; --err: #ff4757;
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-y: auto; /* ‚úÖ fixed scrolling issue */
    }


    /* Sidebar (slide-in settings) */
    .sidebar {
      width: 280px; background: var(--glass); backdrop-filter: blur(12px);
      padding: 20px; display: flex; flex-direction: column;
      border-right: 2px solid rgba(255,255,255,0.1);
      position: fixed; top: 0; left: -280px; height: 100%;
      transition: left 0.3s ease; z-index: 1000;
    }
    .sidebar.active { left: 0; }
    .sidebar h2 { margin-bottom: 15px; font-size: 22px; color: var(--accent); }
    .sidebar input {
      width: 100%; padding: 10px; margin-top: 8px;
      border-radius: 8px; border: none; outline: none;
      background: rgba(255,255,255,0.12); color: #fff;
    }
    .sidebar button {
      margin-top: 15px; padding: 12px; border: none; border-radius: 8px;
      background: linear-gradient(135deg,#ffd369,#f6ab40);
      color: #222; font-weight: bold; cursor: pointer; transition: transform 0.2s;
    }
    .sidebar button:hover { transform: scale(1.05); }

    /* Main */
    .main {
      flex: 1; padding: 20px; overflow-y: auto; margin-left: 0;
      transition: margin-left 0.3s ease; width: 100%; padding-bottom: 88px; /* space for bottom nav on mobile */
    }
    .sidebar.active ~ .main { margin-left: 280px; }

    nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 25px; border-radius: 14px; background: var(--glass);
      backdrop-filter: blur(10px); margin-bottom: 20px;
    }
    .nav-logo { font-size: 22px; font-weight: bold; color: var(--accent); }
    .nav-actions button {
      margin-left: 8px; padding: 10px 16px;
      background: linear-gradient(135deg,var(--btn1),var(--btn2));
      border: none; border-radius: 8px; font-weight: bold; color: #fff; cursor: pointer;
      transition: opacity 0.2s;
    }
    .nav-actions button:hover { opacity: 0.9; }
    .settings-btn {
      background: linear-gradient(135deg,#43e97b,#38f9d7) !important;
      color: #111 !important;
    }

    h2 { margin-top: 5px; font-size: 24px; font-weight: 600; }
    #searchBar {
      margin-top: 15px; width: 100%; padding: 12px; border-radius: 8px; border: none; outline: none;
      background: rgba(255,255,255,0.15); color: #fff; font-size: 16px;
    }

    /* Video Grid */
    .video-grid {
      display: grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
      gap: 20px; margin-top: 20px;
    }
    .video-card {
      background: var(--glass); backdrop-filter: blur(8px);
      border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      padding: 15px; text-align: center; opacity: 0; transform: translateY(20px);
      transition: all 0.4s ease;
    }
    .video-card.show { opacity: 1; transform: translateY(0); }
    .video-card iframe, .video-card video {
      border-radius: 10px; margin-top: 10px; max-width: 100%;
    }
    .video-card h4 { margin: 10px 0; font-size: 18px; color: var(--accent); }
    .video-card:hover { transform: translateY(-5px) scale(1.02); }
    .video-actions { margin-top: 10px; display: flex; justify-content: center; }
    .like-btn {
      padding: 8px 14px; border: none; border-radius: 6px;
      background: var(--err); color: #fff; cursor: pointer; font-weight: bold; transition: transform 0.2s;
    }
    .like-btn:hover { transform: scale(1.05); }
    .like-btn.liked { background: var(--ok); }

    /* Skeletons */
    .skeleton-card {
      background: var(--glass); border-radius: 16px; padding: 15px; overflow: hidden; position: relative;
    }
    .skeleton-thumb, .skeleton-title, .skeleton-btn {
      background: rgba(255,255,255,0.12); border-radius: 10px; position: relative; overflow: hidden;
    }
    .skeleton-thumb { height: 180px; }
    .skeleton-title { height: 18px; margin: 12px 0; width: 70%; }
    .skeleton-btn { height: 36px; width: 120px; margin: 10px auto 0; border-radius: 6px; }
    .shimmer::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
      transform: translateX(-100%); animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 100%{ transform: translateX(100%);} }

    /* Small spinner (top-right) */
    .spinner {
      position: fixed; top: 14px; right: 14px; width: 26px; height: 26px; border: 3px solid rgba(255,255,255,0.35);
      border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; z-index: 2000;
    }
    .spinner.show { display: block; }
    @keyframes spin { to{ transform: rotate(360deg);} }

    /* Toasts */
    .toast-container{
      position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
      display: flex; flex-direction: column; gap: 10px; z-index: 3000; width: min(92%, 440px);
      pointer-events: none;
    }
    .toast{
      pointer-events: auto;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px);
      color: #fff; border-radius: 10px; padding: 12px 14px; display: flex; align-items: center; gap: 10px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
      border-left: 4px solid #999; opacity: 0; transform: translateY(10px) scale(0.98);
      animation: toast-in .22s ease forwards;
    }
    .toast.ok { border-left-color: var(--ok); }
    .toast.err { border-left-color: var(--err); }
    .toast.warn { border-left-color: var(--warn); }
    .toast .msg { flex: 1; }
    .toast .close { background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer; opacity: 0.8; }
    .toast .close:hover { opacity: 1; }
    @keyframes toast-in { to { opacity: 1; transform: translateY(0) scale(1); } }

    /* Bottom Nav (mobile) */
    .bottom-nav{
      position: fixed; bottom: 0; left: 0; right: 0; height: 64px; z-index: 2500;
      background: rgba(15,23,42,0.9); backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,255,255,0.08);
      display: none; grid-template-columns: repeat(4, 1fr);
    }
    .bottom-nav button{
      background: transparent; border: none; color: #e5e7eb; font-weight: 600; font-size: 13px;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; cursor: pointer;
    }
    .bottom-nav button.active { color: #fff; }
    .bottom-nav .icon{ font-size: 18px; line-height: 1; }

    /* Responsive */
    @media(max-width: 768px){
      .nav-actions { display: none; }
      .bottom-nav{ display: grid; }
      .sidebar { width: 100%; left: -100%; }
      .sidebar.active { left: 0; }
      .sidebar.active ~ .main { margin-left: 0; }
    }
  </style>
</head>
<body>

  <!-- Settings Sidebar -->
  <aside class="sidebar" id="settingsPanel">
    <h2>Profile & Settings</h2>
    <p><strong>User:</strong> <span id="userName"></span></p>
    <p><strong>Email:</strong> <span id="userEmail"></span></p>
    <h3 style="margin-top:12px;">Change Password</h3>
    <input type="password" id="currentPassword" placeholder="Current Password">
    <input type="password" id="newPassword" placeholder="New Password">
    <button id="btnChangePassword">Update Password</button>
  </aside>

  <!-- Main -->
  <div class="main" id="dashboard">
    <nav>
      <div class="nav-logo">‚ö° InstantFundsPay</div>
      <div class="nav-actions">
        <button id="btnHistory">üìú History</button>
        <button class="settings-btn" id="btnSettings">‚öô Settings</button>
        <button id="btnLogout">Logout</button>
      </div>
    </nav>

    <h2 id="sectionTitle">Available Videos</h2>
    <input type="text" id="searchBar" placeholder="üîé Search videos...">
    <div id="videoContainer" class="video-grid"></div>
  </div>

  <!-- Bottom Nav (mobile) -->
  <div class="bottom-nav" id="bottomNav">
    <button id="navHome" class="active" aria-label="Home">
      <span class="icon">üè†</span><span>Home</span>
    </button>
    <button id="navHistory" aria-label="History">
      <span class="icon">üìú</span><span>History</span>
    </button>
    <button id="navSettings" aria-label="Settings">
      <span class="icon">‚öô</span><span>Settings</span>
    </button>
    <button id="navLogout" aria-label="Logout">
      <span class="icon">üö™</span><span>Logout</span>
    </button>
  </div>

  <!-- Spinner & Toasts -->
  <div class="spinner" id="spinner"></div>
  <div class="toast-container" id="toasts"></div>

<script>
  /* ======== Auth Guard ======== */
  const token = localStorage.getItem("token");
  if (!token) window.location.href = "/";

  /* ======== DOM Refs ======== */
  const videoContainer = document.getElementById("videoContainer");
  const searchBar = document.getElementById("searchBar");
  const sectionTitle = document.getElementById("sectionTitle");
  const spinner = document.getElementById("spinner");
  const toasts = document.getElementById("toasts");
  const settingsPanel = document.getElementById("settingsPanel");

  const btnSettings = document.getElementById("btnSettings");
  const btnHistory = document.getElementById("btnHistory");
  const btnLogout = document.getElementById("btnLogout");
  const btnChangePassword = document.getElementById("btnChangePassword");

  const navHome = document.getElementById("navHome");
  const navHistory = document.getElementById("navHistory");
  const navSettings = document.getElementById("navSettings");
  const navLogout = document.getElementById("navLogout");

  /* ======== State ======== */
  let allVideos = [];
  let likedVideos = [];
  let showingHistory = false;

  /* ======== Utils ======== */
  function showSpinner(on){ spinner.classList.toggle('show', !!on); }

  function showToast(type, message, timeout=3000){
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<div class="msg">${message}</div><button class="close" aria-label="Close">√ó</button>`;
    toasts.appendChild(el);
    const remove = () => { el.remove(); };
    el.querySelector('.close').addEventListener('click', remove);
    setTimeout(remove, timeout);
  }

  function extractYouTubeId(url) {
    if (!url) return null;
    const m = url.match(/youtu\.be\/([^?&#/]+)/i) ||
              url.match(/[?&]v=([^?&#/]+)/i) ||
              url.match(/youtube\.com\/shorts\/([^?&#/]+)/i) ||
              url.match(/youtube\.com\/embed\/([^?&#/]+)/i);
    return m ? m[1] : null;
  }

  function setActiveBottom(btn){
    [navHome, navHistory, navSettings, navLogout].forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  /* ======== Skeletons ======== */
  function renderSkeletons(count=6){
    videoContainer.innerHTML = "";
    for(let i=0;i<count;i++){
      const card = document.createElement('div');
      card.className = 'skeleton-card';
      card.innerHTML = `
        <div class="skeleton-thumb shimmer"></div>
        <div class="skeleton-title shimmer"></div>
        <div class="skeleton-btn shimmer"></div>
      `;
      videoContainer.appendChild(card);
    }
  }

  /* ======== Data ======== */
  async function loadUser() {
    try{
      showSpinner(true);
      const res = await fetch("/api/me", { headers: { Authorization: "Bearer " + token } });
      const data = await res.json();
      document.getElementById("userName").textContent = (data.email || "").split("@")[0];
      document.getElementById("userEmail").textContent = data.email || "";
      likedVideos = (data.likes || []).map(l => l.videoId);
    }catch(e){
      showToast('err', 'Failed to load user');
    }finally{
      showSpinner(false);
    }
  }

  async function loadVideos() {
    try{
      renderSkeletons();
      showSpinner(true);
      const res = await fetch("/api/videos", { headers: { Authorization: "Bearer " + token } });
      allVideos = await res.json();
      renderVideos(allVideos);
      showToast('ok', 'Videos loaded');
    }catch(e){
      showToast('err', 'Failed to load videos');
      videoContainer.innerHTML = "";
    }finally{
      showSpinner(false);
    }
  }

  /* ======== Render ======== */
  function renderVideos(videos) {
    videoContainer.innerHTML = "";
    videos.forEach(video => {
      if (!video || !video._id || !video.url) return;
      const card = document.createElement("div");
      card.classList.add("video-card");
      const id = extractYouTubeId(video.url);
      const embedContent = id
        ? `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe>`
        : `<video width="100%" height="200" controls><source src="${video.url}" type="video/mp4"></video>`;
      const liked = likedVideos.includes(video._id);
      card.innerHTML = `
        <h4>${video.title || "Untitled"}</h4>
        ${embedContent}
        <div class="video-actions">
          <button class="like-btn ${liked ? "liked" : ""}"
                  onclick="toggleLike('${video._id}','${video.title?.replace(/'/g, "\\'") || ""}','${video.url?.replace(/'/g, "\\'") || ""}', this)">
            ${liked ? "üíö Liked" : "‚ù§ Like"}
          </button>
        </div>`;
      videoContainer.appendChild(card);
      requestAnimationFrame(() => card.classList.add("show"));
    });
  }

  /* ======== Actions ======== */
  async function toggleLike(videoId, title, url, btn) {
    try{
      if (likedVideos.includes(videoId)) {
        likedVideos = likedVideos.filter(v => v !== videoId);
        btn.classList.remove("liked"); btn.textContent = "‚ù§ Like";
        showToast('warn', 'Removed from liked');
      } else {
        likedVideos.push(videoId);
        btn.classList.add("liked"); btn.textContent = "üíö Liked";
        await fetch("/api/like", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
          body: JSON.stringify({ videoId, title, url })
        });
        showToast('ok', 'Saved to liked');
      }
    }catch(e){
      showToast('err', 'Could not update like');
    }
  }
  window.toggleLike = toggleLike; // expose for inline onclick

  function toggleHistory() {
    if (showingHistory) {
      sectionTitle.textContent = "Available Videos";
      renderVideos(allVideos);
      showingHistory = false;
      setActiveBottom(navHome);
    } else {
      const likedOnly = allVideos.filter(v => likedVideos.includes(v._id));
      sectionTitle.textContent = "üíö Your Liked Videos";
      renderVideos(likedOnly);
      showingHistory = true;
      setActiveBottom(navHistory);
    }
  }

  searchBar.addEventListener("input", () => {
    const query = searchBar.value.toLowerCase();
    const filtered = allVideos.filter(v => (v.title || "").toLowerCase().includes(query));
    sectionTitle.textContent = query ? `Search: ${query}` : (showingHistory ? "üíö Your Liked Videos" : "Available Videos");
    renderVideos(filtered);
  });

  async function changePassword() {
    const currentPassword = document.getElementById("currentPassword").value;
    const newPassword = document.getElementById("newPassword").value;
    if(!currentPassword || !newPassword){
      showToast('warn', 'Enter current and new password');
      return;
    }
    try{
      showSpinner(true);
      const res = await fetch("/api/change-password", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ currentPassword, newPassword })
      });
      const data = await res.json();
      if(res.ok){
        showToast('ok', data.message || 'Password updated');
        document.getElementById("currentPassword").value = "";
        document.getElementById("newPassword").value = "";
      }else{
        showToast('err', data.error || data.message || 'Update failed');
      }
    }catch(e){
      showToast('err', 'Network error updating password');
    }finally{
      showSpinner(false);
    }
  }

  function toggleSettings(){ settingsPanel.classList.toggle('active'); }
  function logout(){ localStorage.removeItem("token"); window.location.href = "/"; }

  /* ======== Wire Buttons (Top + Bottom Nav) ======== */
  btnSettings.addEventListener('click', () => { toggleSettings(); setActiveBottom(navSettings); });
  btnHistory.addEventListener('click', toggleHistory);
  btnLogout.addEventListener('click', logout);
  btnChangePassword.addEventListener('click', changePassword);

  navHome.addEventListener('click', () => {
    showingHistory = false; sectionTitle.textContent = "Available Videos"; renderVideos(allVideos); setActiveBottom(navHome);
  });
  navHistory.addEventListener('click', toggleHistory);
  navSettings.addEventListener('click', () => { toggleSettings(); setActiveBottom(navSettings); });
  navLogout.addEventListener('click', logout);

  /* ======== Init ======== */
  (async () => {
    await loadUser();
    await loadVideos();
  })();
</script>
</body>
</html>
