<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - InstantFundsPay</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: "Poppins", sans-serif;
  }

  body {
    background: radial-gradient(circle at top left, #1e293b, #0f172a);
    color: #f8fafc;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 20px;
    overflow-x: hidden;
    perspective: 1000px;
  }

  .container {
    width: 100%;
    max-width: 1200px;
    animation: fadeIn 0.8s ease-in-out;
  }

  header {
    position: sticky;
    top: 0;
    z-index: 20;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px) saturate(160%);
    border-radius: 16px;
    padding: 18px 24px;
    margin-bottom: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    transition: transform 0.4s ease, box-shadow 0.4s ease;
  }

  header.scrolled {
    transform: translateY(-5px) scale(0.98);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }

  header h2 {
    font-size: 1.6em;
    color: #facc15;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  header button {
    background: linear-gradient(135deg, #ef4444, #b91c1c);
    border: none;
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
  }

  header button:hover {
    transform: scale(1.08);
    box-shadow: 0 0 16px rgba(239, 68, 68, 0.6);
  }

  .card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 28px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
    backdrop-filter: blur(16px) saturate(160%);
    transform-style: preserve-3d;
    transform: translateY(0px);
    transition: transform 0.4s ease, box-shadow 0.4s ease;
  }

  .card:hover {
    transform: translateY(-8px) rotateX(3deg);
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.45);
  }

  .card h3 {
    color: #facc15;
    margin-bottom: 15px;
    font-size: 1.2rem;
  }

  input,
  textarea,
  select {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 10px;
    border: none;
    outline: none;
    background: rgba(255, 255, 255, 0.1);
    color: #f8fafc;
    font-size: 0.95rem;
  }

  button {
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: #fff;
    box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
  }

  .btn-primary:hover {
    transform: scale(1.05);
    box-shadow: 0 0 18px rgba(59, 130, 246, 0.8);
  }

  .btn-danger {
    background: linear-gradient(135deg, #ef4444, #b91c1c);
    color: #fff;
    box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
  }

  .btn-danger:hover {
    transform: scale(1.05);
    box-shadow: 0 0 18px rgba(239, 68, 68, 0.8);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(15, 23, 42, 0.6);
    border-radius: 16px;
    overflow: hidden;
    backdrop-filter: blur(14px);
  }

  th,
  td {
    padding: 16px 12px;
    text-align: left;
    font-size: 0.9rem;
  }

  th {
    background: rgba(59, 130, 246, 0.3);
    color: #fff;
    font-weight: 600;
  }

  tr:nth-child(even) {
    background: rgba(255, 255, 255, 0.05);
  }

  tr:hover {
    background: rgba(59, 130, 246, 0.15);
    transition: background 0.3s;
  }

  /* Responsive */
  @media (max-width: 900px) {
    header {
      flex-direction: column;
      gap: 10px;
      text-align: center;
    }

    header button {
      width: 100%;
    }

    table,
    thead,
    tbody,
    th,
    td,
    tr {
      display: block;
    }

    thead {
      display: none;
    }

    tr {
      margin-bottom: 15px;
      border-radius: 12px;
      padding: 10px;
    }

    td {
      padding: 10px;
      text-align: right;
      position: relative;
    }

    td::before {
      content: attr(data-label);
      position: absolute;
      left: 10px;
      font-weight: 600;
      color: #93c5fd;
      text-align: left;
    }
  }

  /* Fade in animation */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  // Parallax scroll for header
  window.addEventListener("scroll", () => {
    const header = document.querySelector("header");
    if (window.scrollY > 20) header.classList.add("scrolled");
    else header.classList.remove("scrolled");
  });

  // Floating card effect based on mouse position
  document.addEventListener("mousemove", (e) => {
    document.querySelectorAll(".card").forEach((card) => {
      const speed = card.getAttribute("data-speed") || 3;
      const x = (window.innerWidth / 2 - e.pageX) / 100 / speed;
      const y = (window.innerHeight / 2 - e.pageY) / 100 / speed;
      card.style.transform = `rotateY(${x}deg) rotateX(${y}deg) translateY(-8px)`;
    });
  });
</script>


</head>
<body>
  <div class="bg-blobs">
  <span></span>
  <span></span>
  <span></span>
</div>

  <div class="container" id="admin-dashboard">
    <header>
      <h2>Admin Dashboard - InstantFundsPay</h2>
      <button onclick="logout()">Logout</button>
    </header>

    <!-- Upload Local Video -->
    <section class="card upload">
      <h3>Upload Local Video</h3>
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="text" name="title" placeholder="Video Title" required />
        <input type="file" name="video" accept="video/*" required />
        <button type="submit" class="btn-primary">Upload Video</button>
      </form>
      <p id="uploadMessage"></p>
    </section>

    <!-- Manage Videos -->
<section class="card videos">
  <h3>Manage Videos</h3>
  <a href="admin-videos.html">
    <button class="btn-primary">Go to Video Manager</button>
  </a>
</section>


    <!-- Add YouTube Video -->
    <section class="card upload">
      <h3>Add YouTube Video</h3>
          <form id="youtubeForm">
      <input type="text" id="youtube-url" placeholder="YouTube URL" required />
      <button type="submit" class="btn-primary">Add YouTube Video</button>
    </form>
      <p id="youtubeMessage"></p>
    </section>

    <!-- Manage Videos -->
   <!--<section class="card videos">
      <h3>All Videos</h3>
      <div class="video-grid" id="admin-video-list"></div>
    </section>-->
    <!-- Admin Chat Section -->
<section class="card chat">
  <h3>Chat with Users</h3>
  <label for="chatUserSelect">Select User:</label>
  <select id="chatUserSelect"></select>

  <div id="chatMessages" style="max-height: 300px; overflow-y: auto; margin: 15px 0; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;"></div>

  <textarea id="adminMessageInput" placeholder="Type your message..."></textarea>
  <button class="btn-primary" onclick="sendAdminMessage()">Send Message</button>
</section>

    <!-- Manage Users -->
    <section class="card users">
      <h3>All Users</h3>
     <table>
  <thead>
    <tr>
      <th>Email</th>
      <th>Role</th>
      <th>Last IP</th>
      <th>Location</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="user-list"></tbody>
</table>

    </section>
  </div>

  <!-- 🧠 The full <head>, styles, and structure remain the same so we keep your layout as is -->
<!-- Only the <scr> section is modified below -->
<script>
  let selectedChatUser = null;
  let lastMessageCounts = {}; // track counts per user
  const token = localStorage.getItem("token");

  if (!token) {
    alert("No token found. Please log in again.");
    window.location.href = "/";
  }

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "/";
  }

  // ✅ Toast Notification

  // ✅ Snackbar-style Toast (bottom slide-in)
  function showToast(message, error = false) {
    const toast = document.createElement("div");
    toast.className = "snackbar";
    toast.style.background = error
      ? "rgba(231,76,60,0.95)"
      : "rgba(52,152,219,0.95)";
    toast.innerText = message;

    document.body.appendChild(toast);

    // Slide in
    setTimeout(() => {
      toast.classList.add("show");
    }, 100);

    // Remove after 4s
    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // ✅ Inject CSS once
  const toastStyles = document.createElement("style");
  toastStyles.innerHTML = `
    .snackbar {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background: rgba(52,152,219,0.95);
      color: #fff;
      text-align: center;
      border-radius: 10px;
      padding: 14px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: -80px;
      font-size: 15px;
      transition: bottom 0.3s ease, visibility 0.3s ease;
    }
    .snackbar.show {
      visibility: visible;
      bottom: 30px; /* slides up */
    }
  `;
  document.head.appendChild(toastStyles);

  // ✅ Load Videos & Users
 // ✅ Load Videos & Users
// Load videos and their like stats

// --- Helpers ---
function getVideoId(url) {
  try {
    if (url.includes("shorts/")) {
      return url.split("shorts/")[1].split("?")[0];
    } else if (url.includes("watch?v=")) {
      return url.split("watch?v=")[1].split("&")[0];
    } else if (url.includes("youtu.be/")) {
      return url.split("youtu.be/")[1].split("?")[0];
    }
    return "";
  } catch {
    return "";
  }
}

function getEmbedUrl(url) {
  const id = getVideoId(url);
  return id ? `https://www.youtube.com/embed/${id}` : "";
}

function getThumbnailUrl(url) {
  const id = getVideoId(url);
  return id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : "fallback.jpg";
}
function createLazyVideo(url, title = "") {
  const match = url.match(/\/upload\/(?:v\d+\/)?([^\.]+)/);
  const publicId = match ? match[1] : null;

  const thumbUrl = publicId
  ? `https://res.cloudinary.com/dvra4pmc7/video/upload/w_400,h_225,c_fill,so_0/${publicId}.jpg`
  : "https://via.placeholder.com/400x225?text=Video";

  return `
    <div class="lazy-video" data-url="${url}">
      <img src="${thumbUrl}" alt="${title}" loading="lazy"/>
      <button class="play-btn">▶</button>
    </div>
  `;
}


function createLazyEmbed(url) {
  const thumb = getThumbnailUrl(url);
  return `
    <div class="video-thumb" data-url="${url}" 
         style="position:relative;cursor:pointer;">
      <img src="${thumb}" style="width:100%;border-radius:8px;">
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
        background:rgba(0,0,0,0.7);color:white;font-size:24px;
        padding:12px 18px;border-radius:50%;user-select:none;">
        ▶
      </div>
    </div>
  `;
}

// --- Modified loadVideos with thumbnails ---

// ================== Main Function ==================



// --- Global click handler: replace thumb with iframe ---
document.addEventListener("click", (e) => {
  const thumb = e.target.closest(".video-thumb");
  if (thumb) {
    const url = thumb.getAttribute("data-url");
    const iframe = document.createElement("iframe");
    iframe.src = getEmbedUrl(url) + "?autoplay=1";
    iframe.frameBorder = "0";
    iframe.allow =
      "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    iframe.style.width = "100%";
    iframe.style.height = "315px";
    thumb.replaceWith(iframe);
  }
});

// ✅ Lazy load for local videos
document.addEventListener("click", (e) => {
  const wrapper = e.target.closest(".lazy-video");
  if (wrapper) {
    const url = wrapper.dataset.url;
    wrapper.innerHTML = `
      <video src="${url}" controls autoplay></video>
    `;
  }
});

async function loadUsers() {
  try {
    const usersRes = await fetch("/api/admin/users", {
      headers: { Authorization: "Bearer " + token }
    });
    const users = await usersRes.json();
    const userList = document.getElementById("user-list");
    const select = document.getElementById("chatUserSelect");
    userList.innerHTML = "";
    select.innerHTML = "<option value=''>-- Select User --</option>";

    users.forEach(u => {
      const row = document.createElement("tr");
     row.innerHTML = `
  <td data-label="Email">${u.email}</td>
  <td data-label="Role">${u.role}</td>
  <td data-label="Last IP">${u.lastIp || 'N/A'}</td>
  <td data-label="Location">${u.location || 'Unknown'}</td>
  <td data-label="Actions">
    <button class="btn-danger" onclick="deleteUser('${u._id}')">Remove</button>
  </td>
`;

      userList.appendChild(row);

      const opt = document.createElement("option");
      opt.value = u.email;
      opt.textContent = u.email;
      select.appendChild(opt);
    });
  } catch (err) {
    showToast("❌ Error loading users: " + err.message, true);
  }
}



// Load users
/*async function loadUsers() {
  try {
    const usersRes = await fetch("/api/admin/users", {
      headers: { Authorization: "Bearer " + token }
    });
    const users = await usersRes.json();
    const userList = document.getElementById("user-list");
    const select = document.getElementById("chatUserSelect");
    userList.innerHTML = "";
    select.innerHTML = "<option value=''>-- Select User --</option>";

    users.forEach(u => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${u.email}</td>
        <td>${u.role}</td>
        <td><button class="btn-danger" onclick="deleteUser('${u._id}')">Remove</button></td>`;
      userList.appendChild(row);

      const opt = document.createElement("option");
      opt.value = u.email;
      opt.textContent = u.email;
      select.appendChild(opt);
    });
  } catch (err) {
    showToast("❌ Error loading users: " + err.message, true);
  }
}*/


  // ✅ Chat
  async function loadChatMessages(userEmail) {
    if (!userEmail) return;

    try {
      const res = await fetch(`/api/chat/messages/${userEmail}`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) throw new Error("Failed to load messages");

      const messages = await res.json();

      // ✅ Notify if new message from this user
      if (lastMessageCounts[userEmail] !== undefined && messages.length > lastMessageCounts[userEmail]) {
        if (selectedChatUser !== userEmail) {
          showToast(`📩 New message from ${userEmail}`);
        }
      }
      lastMessageCounts[userEmail] = messages.length;

      // ✅ Render
      if (selectedChatUser === userEmail) {
        const messagesDiv = document.getElementById("chatMessages");
        messagesDiv.innerHTML = "";
        messages.forEach(msg => {
          const bubble = document.createElement("div");
          bubble.textContent = `${msg.sender}: ${msg.message}`;
          bubble.style.marginBottom = "8px";
          bubble.style.padding = "6px 10px";
          bubble.style.borderRadius = "8px";
          bubble.style.background = msg.sender === "admin" ? "#3498db" : "#2ecc71";
          bubble.style.color = "#fff";
          bubble.style.textAlign = msg.sender === "admin" ? "right" : "left";
          messagesDiv.appendChild(bubble);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    } catch (err) {
      console.error("Chat load error", err);
    }
  }

  async function sendAdminMessage() {
    const email = document.getElementById("chatUserSelect").value.trim();
    const msg = document.getElementById("adminMessageInput").value.trim();
    if (!email || !msg) return showToast("Please select a user and type a message.", true);

    try {
      const res = await fetch(`/api/chat/messages/${email}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || "Failed to send");
      showToast("✅ Message sent");
      document.getElementById("adminMessageInput").value = "";
      loadChatMessages(email);
    } catch (err) {
      showToast("❌ " + err.message, true);
    }
  }
document.getElementById("youtubeForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const urlInput = document.getElementById("youtube-url");
  if (!urlInput) {
    console.error("❌ youtube-url input not found in DOM");
    return;
  }

  const url = urlInput.value.trim();
  if (!url) return showToast("❌ Please enter a YouTube URL", true);

  const res = await fetch("/api/admin/videos/youtube", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token,
    },
    body: JSON.stringify({ url }),
  });

  // after successful YouTube upload
if (res.ok) {
  showToast("✅ YouTube video added successfully");
  e.target.reset();
  window.location.href = "admin-videos.html"; // instead of loadVideos()
} else {
    const err = await res.json();
    showToast("❌ " + (err.message || "Failed to add YouTube video"), true);
  }
});
// ================= Local Upload via Backend =================
async function uploadVideo(file, title) {
  const token = localStorage.getItem("token"); // you stored admin JWT after login

  const formData = new FormData();
  formData.append("video", file);       // 👈 must match upload.single("video")
  formData.append("title", title);

  const res = await fetch("/api/admin/videos/upload", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token, // 👈 required for admin
    },
    body: formData,
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error("Upload failed: " + err.error);
  }
  return await res.json();
}

// ✅ Local Upload to Cloudinary
const cloudName = "dvra4pmc7";       // 🔑 replace with your Cloudinary cloud name
const uploadPreset = "ml_default"; // 🔑 replace with your unsigned preset

document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = e.target.title.value.trim();
  const file = e.target.video.files[0];
  if (!file) return showToast("❌ Please select a video file", true);

  showToast("⏳ Uploading video...");
// after successful local upload
try {
  const result = await uploadVideo(file, title);
  showToast("✅ Video uploaded successfully");
  e.target.reset();
  window.location.href = "admin-videos.html"; // instead of loadVideos()
} catch (err) {
  console.error("Upload error:", err);
  showToast("❌ " + err.message, true);
}
});

  document.getElementById("chatUserSelect").addEventListener("change", e => {
    selectedChatUser = e.target.value || null;
    if (selectedChatUser) loadChatMessages(selectedChatUser);
    else document.getElementById("chatMessages").innerHTML = "<p>No user selected.</p>";
  });

  

  // ✅ Delete

  async function deleteUser(id) {
    await fetch(`/api/admin/users/${id}`, { method: "DELETE", headers: { Authorization: "Bearer " + token } });
    showToast("✅ User removed");
    loadUsers();
  }

  // ✅ Polling every 5s for all users
  setInterval(async () => {
    const select = document.getElementById("chatUserSelect");
    Array.from(select.options).forEach(opt => {
      if (opt.value) loadChatMessages(opt.value);
    });
  }, 5000);

  // Init
  // loadAdminData();
  document.addEventListener("DOMContentLoaded", () => {
  loadUsers();
});

</script>

</body>
</html>
