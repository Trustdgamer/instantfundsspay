<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - InstantFundsPay</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    body {
      background: linear-gradient(135deg, #141e30, #243b55);
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .container { width: 100%; max-width: 1200px; }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 20px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
    }
    header h2 { font-size: 1.6em; color: #f9d342; }
    header button {
      background: #e74c3c; border: none; color: #fff;
      padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: 0.3s;
    }
    header button:hover { background: #c0392b; }
body {
  background: #0f172a; /* dark slate background */
  color: #f5f5f5;
  overflow-x: hidden;
}

.bg-blobs {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}

.bg-blobs span {
  position: absolute;
  border-radius: 50%;
  filter: blur(100px);
  opacity: 0.6;
  animation: moveBlobs 20s infinite alternate ease-in-out;
}

.bg-blobs span:nth-child(1) {
  width: 400px; height: 400px;
  background: #3498db;
  top: -100px; left: -100px;
}
.bg-blobs span:nth-child(2) {
  width: 350px; height: 350px;
  background: #9b59b6;
  bottom: -150px; right: -100px;
}
.bg-blobs span:nth-child(3) {
  width: 300px; height: 300px;
  background: #f39c12;
  top: 50%; left: 40%;
}

@keyframes moveBlobs {
  from { transform: translate(0, 0) scale(1); }
  to { transform: translate(50px, -50px) scale(1.2); }
}

    /* Cards */
    .card {
      background: rgba(255, 255, 255, 0.08);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
    }
    .card h3 { margin-bottom: 15px; color: #f9d342; }
    input, textarea {
      width: 100%; padding: 12px; margin-bottom: 12px;
      border-radius: 6px; border: none; outline: none; font-size: 14px;
    }
    button { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #3498db; color: #fff; transition: 0.3s; }
    .btn-primary:hover { background: #2980b9; }
    .btn-danger { background: #e74c3c; color: #fff; transition: 0.3s; }
    .btn-danger:hover { background: #c0392b; }

    /* Video Grid */
    .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .lazy-video {
  position: relative;
  display: inline-block;
  cursor: pointer;
}
.lazy-video img {
  width: 100%;
  border-radius: 8px;
}
.lazy-video .play-btn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.6);
  border: none;
  color: white;
  font-size: 2rem;
  border-radius: 50%;
  padding: 10px 15px;
  cursor: pointer;
}

    .video-card {
      background: rgba(0,0,0,0.5);
      border-radius: 10px; padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      text-align: center; transition: transform 0.2s;
    }
    .video-card iframe,
.video-card video {
  width: 100%;
  aspect-ratio: 16 / 9;
  border-radius: 8px;
}

    .video-card:hover { transform: scale(1.03); }
    .video-card h4 { margin-bottom: 10px; color: #f9d342; font-size: 1em; }
    .video-card video, .video-card iframe {
      width: 100%; border-radius: 8px; margin-bottom: 10px;
    }

    /* Table */
    table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.6); border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px 15px; text-align: left; }
    th { background: #3498db; color: #fff; }
    tr:nth-child(even) { background: rgba(255, 255, 255, 0.05); }
    tr td { color: #f5f5f5; }

    /* Toasts */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      margin-top: 8px;
      animation: fadeInOut 4s forwards;
      z-index: 2000;
      font-size: 14px;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translateY(20px); }
    }

    /* Mobile adjustments */
    @media(max-width:768px) {
      .video-grid { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; gap: 10px; }
      header h2 { font-size: 1.3em; }
      header button { width: 100%; text-align: center; }
      .btn-primary, .btn-danger { width: 100%; margin-top: 8px; }
    }
  </style>
</head>
<body>
  <div class="bg-blobs">
  <span></span>
  <span></span>
  <span></span>
</div>

  <div class="container" id="admin-dashboard">
    <header>
      <h2>Admin Dashboard - InstantFundsPay</h2>
      <button onclick="logout()">Logout</button>
    </header>

    <!-- Upload Local Video -->
    <section class="card upload">
      <h3>Upload Local Video</h3>
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="text" name="title" placeholder="Video Title" required />
        <input type="file" name="video" accept="video/*" required />
        <button type="submit" class="btn-primary">Upload Video</button>
      </form>
      <p id="uploadMessage"></p>
    </section>

    <!-- Add YouTube Video -->
    <section class="card upload">
      <h3>Add YouTube Video</h3>
          <form id="youtubeForm">
      <input type="text" id="youtube-url" placeholder="YouTube URL" required />
      <button type="submit" class="btn-primary">Add YouTube Video</button>
    </form>
      <p id="youtubeMessage"></p>
    </section>

    <!-- Manage Videos -->
    <section class="card videos">
      <h3>All Videos</h3>
      <div class="video-grid" id="admin-video-list"></div>
    </section>
    <!-- Admin Chat Section -->
<section class="card chat">
  <h3>Chat with Users</h3>
  <label for="chatUserSelect">Select User:</label>
  <select id="chatUserSelect"></select>

  <div id="chatMessages" style="max-height: 300px; overflow-y: auto; margin: 15px 0; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;"></div>

  <textarea id="adminMessageInput" placeholder="Type your message..."></textarea>
  <button class="btn-primary" onclick="sendAdminMessage()">Send Message</button>
</section>

    <!-- Manage Users -->
    <section class="card users">
      <h3>All Users</h3>
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="user-list"></tbody>
      </table>
    </section>
  </div>

  <!-- 🧠 The full <head>, styles, and structure remain the same so we keep your layout as is -->
<!-- Only the <scr> section is modified below -->
<script>
  let selectedChatUser = null;
  let lastMessageCounts = {}; // track counts per user
  const token = localStorage.getItem("token");

  if (!token) {
    alert("No token found. Please log in again.");
    window.location.href = "/";
  }

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "/";
  }

  // ✅ Toast Notification

  // ✅ Snackbar-style Toast (bottom slide-in)
  function showToast(message, error = false) {
    const toast = document.createElement("div");
    toast.className = "snackbar";
    toast.style.background = error
      ? "rgba(231,76,60,0.95)"
      : "rgba(52,152,219,0.95)";
    toast.innerText = message;

    document.body.appendChild(toast);

    // Slide in
    setTimeout(() => {
      toast.classList.add("show");
    }, 100);

    // Remove after 4s
    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // ✅ Inject CSS once
  const toastStyles = document.createElement("style");
  toastStyles.innerHTML = `
    .snackbar {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background: rgba(52,152,219,0.95);
      color: #fff;
      text-align: center;
      border-radius: 10px;
      padding: 14px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: -80px;
      font-size: 15px;
      transition: bottom 0.3s ease, visibility 0.3s ease;
    }
    .snackbar.show {
      visibility: visible;
      bottom: 30px; /* slides up */
    }
  `;
  document.head.appendChild(toastStyles);

  // ✅ Load Videos & Users
 // ✅ Load Videos & Users
// Load videos and their like stats

// --- Helpers ---
function getVideoId(url) {
  try {
    if (url.includes("shorts/")) {
      return url.split("shorts/")[1].split("?")[0];
    } else if (url.includes("watch?v=")) {
      return url.split("watch?v=")[1].split("&")[0];
    } else if (url.includes("youtu.be/")) {
      return url.split("youtu.be/")[1].split("?")[0];
    }
    return "";
  } catch {
    return "";
  }
}

function getEmbedUrl(url) {
  const id = getVideoId(url);
  return id ? `https://www.youtube.com/embed/${id}` : "";
}

function getThumbnailUrl(url) {
  const id = getVideoId(url);
  return id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : "fallback.jpg";
}
function createLazyVideo(url, title = "") {
  const match = url.match(/\/upload\/(?:v\d+\/)?([^\.]+)/);
  const publicId = match ? match[1] : null;

  const thumbUrl = publicId
    ? url.replace("/upload/", "/upload/w_400,h_225,c_fill,so_0/") + ".jpg"
    : "https://via.placeholder.com/400x225?text=Video";

  return `
    <div class="lazy-video" data-url="${url}">
      <img src="${thumbUrl}" alt="${title}" loading="lazy"/>
      <button class="play-btn">▶</button>
    </div>
  `;
}


function createLazyEmbed(url) {
  const thumb = getThumbnailUrl(url);
  return `
    <div class="video-thumb" data-url="${url}" 
         style="position:relative;cursor:pointer;">
      <img src="${thumb}" style="width:100%;border-radius:8px;">
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
        background:rgba(0,0,0,0.7);color:white;font-size:24px;
        padding:12px 18px;border-radius:50%;user-select:none;">
        ▶
      </div>
    </div>
  `;
}

// --- Modified loadVideos with thumbnails ---

// ================== Main Function ==================
async function loadVideos() {
  try {
    const videosRes = await fetch("/api/admin/videos", {
      headers: { Authorization: "Bearer " + token }
    });
    const videos = await videosRes.json();
    const videoList = document.getElementById("admin-video-list");
    videoList.innerHTML = "";

    const stats = await fetch("/api/admin/video-stats", {
      headers: { Authorization: "Bearer " + token }
    }).then(res => res.json());

    videos.forEach(v => {
      const card = document.createElement("div");
      card.classList.add("video-card");
      card.id = `video-${v._id}`;

      let media;
      if (v.url.includes("youtube.com") || v.url.includes("youtu.be")) {
        media = createLazyEmbed(v.url);
      } else {
        media = createLazyVideo(v.url, v.title);
      }

      const likeCount = stats[v._id] || 0;

      card.innerHTML = `
        ${media}
        <p class="like-count">👍 ${likeCount} Likes</p>
        <button class="btn-danger" onclick="deleteVideo('${v._id}')">Delete</button>
      `;
      videoList.appendChild(card);
    });

    // 🔄 Poll like stats every 5s
    setInterval(async () => {
      try {
        const newStats = await fetch("/api/admin/video-stats", {
          headers: { Authorization: "Bearer " + token }
        }).then(res => res.json());

        videos.forEach(v => {
          const likeCount = newStats[v._id] || 0;
          const card = document.getElementById(`video-${v._id}`);
          if (card) {
            card.querySelector(".like-count").textContent = `👍 ${likeCount} Likes`;
          }
        });
      } catch (err) {
        console.error("Error refreshing like stats:", err);
      }
    }, 5000);

  } catch (err) {
    showToast("❌ Error loading videos: " + err.message, true);
  }
}


// --- Global click handler: replace thumb with iframe ---
document.addEventListener("click", (e) => {
  const thumb = e.target.closest(".video-thumb");
  if (thumb) {
    const url = thumb.getAttribute("data-url");
    const iframe = document.createElement("iframe");
    iframe.src = getEmbedUrl(url) + "?autoplay=1";
    iframe.frameBorder = "0";
    iframe.allow =
      "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    iframe.style.width = "100%";
    iframe.style.height = "315px";
    thumb.replaceWith(iframe);
  }
});

// ✅ Lazy load for local videos
document.addEventListener("click", (e) => {
  const wrapper = e.target.closest(".lazy-video");
  if (wrapper) {
    const url = wrapper.dataset.url;
    wrapper.innerHTML = `
      <video src="${url}" controls autoplay></video>
    `;
  }
});




// Load users
async function loadUsers() {
  try {
    const usersRes = await fetch("/api/admin/users", {
      headers: { Authorization: "Bearer " + token }
    });
    const users = await usersRes.json();
    const userList = document.getElementById("user-list");
    const select = document.getElementById("chatUserSelect");
    userList.innerHTML = "";
    select.innerHTML = "<option value=''>-- Select User --</option>";

    users.forEach(u => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${u.email}</td>
        <td>${u.role}</td>
        <td><button class="btn-danger" onclick="deleteUser('${u._id}')">Remove</button></td>`;
      userList.appendChild(row);

      const opt = document.createElement("option");
      opt.value = u.email;
      opt.textContent = u.email;
      select.appendChild(opt);
    });
  } catch (err) {
    showToast("❌ Error loading users: " + err.message, true);
  }
}


  // ✅ Chat
  async function loadChatMessages(userEmail) {
    if (!userEmail) return;

    try {
      const res = await fetch(`/api/chat/messages/${userEmail}`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) throw new Error("Failed to load messages");

      const messages = await res.json();

      // ✅ Notify if new message from this user
      if (lastMessageCounts[userEmail] !== undefined && messages.length > lastMessageCounts[userEmail]) {
        if (selectedChatUser !== userEmail) {
          showToast(`📩 New message from ${userEmail}`);
        }
      }
      lastMessageCounts[userEmail] = messages.length;

      // ✅ Render
      if (selectedChatUser === userEmail) {
        const messagesDiv = document.getElementById("chatMessages");
        messagesDiv.innerHTML = "";
        messages.forEach(msg => {
          const bubble = document.createElement("div");
          bubble.textContent = `${msg.sender}: ${msg.message}`;
          bubble.style.marginBottom = "8px";
          bubble.style.padding = "6px 10px";
          bubble.style.borderRadius = "8px";
          bubble.style.background = msg.sender === "admin" ? "#3498db" : "#2ecc71";
          bubble.style.color = "#fff";
          bubble.style.textAlign = msg.sender === "admin" ? "right" : "left";
          messagesDiv.appendChild(bubble);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    } catch (err) {
      console.error("Chat load error", err);
    }
  }

  async function sendAdminMessage() {
    const email = document.getElementById("chatUserSelect").value.trim();
    const msg = document.getElementById("adminMessageInput").value.trim();
    if (!email || !msg) return showToast("Please select a user and type a message.", true);

    try {
      const res = await fetch(`/api/chat/messages/${email}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || "Failed to send");
      showToast("✅ Message sent");
      document.getElementById("adminMessageInput").value = "";
      loadChatMessages(email);
    } catch (err) {
      showToast("❌ " + err.message, true);
    }
  }
document.getElementById("youtubeForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const urlInput = document.getElementById("youtube-url");
  if (!urlInput) {
    console.error("❌ youtube-url input not found in DOM");
    return;
  }

  const url = urlInput.value.trim();
  if (!url) return showToast("❌ Please enter a YouTube URL", true);

  const res = await fetch("/api/admin/videos/youtube", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token,
    },
    body: JSON.stringify({ url }),
  });

  if (res.ok) {
    showToast("✅ YouTube video added successfully");
    e.target.reset();
    loadVideos();
  } else {
    const err = await res.json();
    showToast("❌ " + (err.message || "Failed to add YouTube video"), true);
  }
});
// ================= Local Upload via Backend =================
async function uploadVideo(file, title) {
  const token = localStorage.getItem("token"); // you stored admin JWT after login

  const formData = new FormData();
  formData.append("video", file);       // 👈 must match upload.single("video")
  formData.append("title", title);

  const res = await fetch("/api/admin/videos/upload", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token, // 👈 required for admin
    },
    body: formData,
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error("Upload failed: " + err.error);
  }
  return await res.json();
}

// ✅ Local Upload to Cloudinary
const cloudName = "dvra4pmc7";       // 🔑 replace with your Cloudinary cloud name
const uploadPreset = "ml_default"; // 🔑 replace with your unsigned preset

document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = e.target.title.value.trim();
  const file = e.target.video.files[0];
  if (!file) return showToast("❌ Please select a video file", true);

  showToast("⏳ Uploading video...");

  try {
    const result = await uploadVideo(file, title);
    showToast("✅ Video uploaded successfully");
    e.target.reset();
    loadVideos();
  } catch (err) {
    console.error("Upload error:", err);
    showToast("❌ " + err.message, true);
  }
});

  document.getElementById("chatUserSelect").addEventListener("change", e => {
    selectedChatUser = e.target.value || null;
    if (selectedChatUser) loadChatMessages(selectedChatUser);
    else document.getElementById("chatMessages").innerHTML = "<p>No user selected.</p>";
  });

  

  // ✅ Delete
  async function deleteVideo(id) {
    await fetch(`/api/admin/videos/${id}`, { method: "DELETE", headers: { Authorization: "Bearer " + token } });
    showToast("✅ Video deleted");
    loadVideos();
  }

  async function deleteUser(id) {
    await fetch(`/api/admin/users/${id}`, { method: "DELETE", headers: { Authorization: "Bearer " + token } });
    showToast("✅ User removed");
    loadUsers();
  }

  // ✅ Polling every 5s for all users
  setInterval(async () => {
    const select = document.getElementById("chatUserSelect");
    Array.from(select.options).forEach(opt => {
      if (opt.value) loadChatMessages(opt.value);
    });
  }, 5000);

  // Init
  // loadAdminData();
  document.addEventListener("DOMContentLoaded", () => {
  loadVideos();
  loadUsers();
});

</script>

</body>
</html>
