<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - InstantFundsPay</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    body {
      background: linear-gradient(135deg, #141e30, #243b55);
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .container { width: 100%; max-width: 1200px; }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 20px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
    }
    header h2 { font-size: 1.6em; color: #f9d342; }
    header button {
      background: #e74c3c; border: none; color: #fff;
      padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: 0.3s;
    }
    header button:hover { background: #c0392b; }
body {
  background: #0f172a; /* dark slate background */
  color: #f5f5f5;
  overflow-x: hidden;
}

.bg-blobs {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}

.bg-blobs span {
  position: absolute;
  border-radius: 50%;
  filter: blur(100px);
  opacity: 0.6;
  animation: moveBlobs 20s infinite alternate ease-in-out;
}

.bg-blobs span:nth-child(1) {
  width: 400px; height: 400px;
  background: #3498db;
  top: -100px; left: -100px;
}
.bg-blobs span:nth-child(2) {
  width: 350px; height: 350px;
  background: #9b59b6;
  bottom: -150px; right: -100px;
}
.bg-blobs span:nth-child(3) {
  width: 300px; height: 300px;
  background: #f39c12;
  top: 50%; left: 40%;
}

@keyframes moveBlobs {
  from { transform: translate(0, 0) scale(1); }
  to { transform: translate(50px, -50px) scale(1.2); }
}

    /* Cards */
    .card {
      background: rgba(255, 255, 255, 0.08);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
    }
    .card h3 { margin-bottom: 15px; color: #f9d342; }
    input, textarea {
      width: 100%; padding: 12px; margin-bottom: 12px;
      border-radius: 6px; border: none; outline: none; font-size: 14px;
    }
    button { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #3498db; color: #fff; transition: 0.3s; }
    .btn-primary:hover { background: #2980b9; }
    .btn-danger { background: #e74c3c; color: #fff; transition: 0.3s; }
    .btn-danger:hover { background: #c0392b; }

    /* Video Grid */
    .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .video-card {
      background: rgba(0,0,0,0.5);
      border-radius: 10px; padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      text-align: center; transition: transform 0.2s;
    }
    .video-card:hover { transform: scale(1.03); }
    .video-card h4 { margin-bottom: 10px; color: #f9d342; font-size: 1em; }
    .video-card video, .video-card iframe {
      width: 100%; border-radius: 8px; margin-bottom: 10px;
    }

    /* Table */
    table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.6); border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px 15px; text-align: left; }
    th { background: #3498db; color: #fff; }
    tr:nth-child(even) { background: rgba(255, 255, 255, 0.05); }
    tr td { color: #f5f5f5; }

    /* Toasts */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      margin-top: 8px;
      animation: fadeInOut 4s forwards;
      z-index: 2000;
      font-size: 14px;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translateY(20px); }
    }

    /* Mobile adjustments */
    @media(max-width:768px) {
      .video-grid { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; gap: 10px; }
      header h2 { font-size: 1.3em; }
      header button { width: 100%; text-align: center; }
      .btn-primary, .btn-danger { width: 100%; margin-top: 8px; }
    }
  </style>
</head>
<body>
  <div class="bg-blobs">
  <span></span>
  <span></span>
  <span></span>
</div>

  <div class="container" id="admin-dashboard">
    <header>
      <h2>Admin Dashboard - InstantFundsPay</h2>
      <button onclick="logout()">Logout</button>
    </header>

    <!-- Upload Local Video -->
    <section class="card upload">
      <h3>Upload Local Video</h3>
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="text" name="title" placeholder="Video Title" required />
        <input type="file" name="video" accept="video/*" required />
        <button type="submit" class="btn-primary">Upload Video</button>
      </form>
      <p id="uploadMessage"></p>
    </section>

    <!-- Add YouTube Video -->
    <section class="card upload">
      <h3>Add YouTube Video</h3>
      <form id="youtubeForm">
        <input type="text" name="title" placeholder="Video Title" />
        <input type="text" name="url" placeholder="YouTube URL" required />
        <button type="submit" class="btn-primary">Add YouTube Video</button>
      </form>
      <p id="youtubeMessage"></p>
    </section>

    <!-- Manage Videos -->
    <section class="card videos">
      <h3>All Videos</h3>
      <div class="video-grid" id="admin-video-list"></div>
    </section>
    <!-- Admin Chat Section -->
<section class="card chat">
  <h3>Chat with Users</h3>
  <label for="chatUserSelect">Select User:</label>
  <select id="chatUserSelect"></select>

  <div id="chatMessages" style="max-height: 300px; overflow-y: auto; margin: 15px 0; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;"></div>

  <textarea id="adminMessageInput" placeholder="Type your message..."></textarea>
  <button class="btn-primary" onclick="sendAdminMessage()">Send Message</button>
</section>

    <!-- Manage Users -->
    <section class="card users">
      <h3>All Users</h3>
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="user-list"></tbody>
      </table>
    </section>
  </div>

  <!-- üß† The full <head>, styles, and structure remain the same so we keep your layout as is -->
<!-- Only the <scr> section is modified below -->
<script>
  let selectedChatUser = null;
  let lastMessageCounts = {}; // track counts per user
  const token = localStorage.getItem("token");

  if (!token) {
    alert("No token found. Please log in again.");
    window.location.href = "/";
  }

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "/";
  }

  // ‚úÖ Toast Notification

  // ‚úÖ Snackbar-style Toast (bottom slide-in)
  function showToast(message, error = false) {
    const toast = document.createElement("div");
    toast.className = "snackbar";
    toast.style.background = error
      ? "rgba(231,76,60,0.95)"
      : "rgba(52,152,219,0.95)";
    toast.innerText = message;

    document.body.appendChild(toast);

    // Slide in
    setTimeout(() => {
      toast.classList.add("show");
    }, 100);

    // Remove after 4s
    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // ‚úÖ Inject CSS once
  const toastStyles = document.createElement("style");
  toastStyles.innerHTML = `
    .snackbar {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background: rgba(52,152,219,0.95);
      color: #fff;
      text-align: center;
      border-radius: 10px;
      padding: 14px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: -80px;
      font-size: 15px;
      transition: bottom 0.3s ease, visibility 0.3s ease;
    }
    .snackbar.show {
      visibility: visible;
      bottom: 30px; /* slides up */
    }
  `;
  document.head.appendChild(toastStyles);

  // ‚úÖ Load Videos & Users
 // ‚úÖ Load Videos & Users
// Load videos and their like stats
async function loadVideos() {
  try {
    const videosRes = await fetch("/api/admin/videos", {
      headers: { Authorization: "Bearer " + token }
    });
    const videos = await videosRes.json();
    const videoList = document.getElementById("admin-video-list");
    videoList.innerHTML = "";

    // Fetch like stats
    const stats = await fetch("/api/admin/video-stats", {
      headers: { Authorization: "Bearer " + token }
    }).then(res => res.json());

    videos.forEach(v => {
      const card = document.createElement("div");
      card.classList.add("video-card");
      card.id = `video-${v._id}`;

      const media = v.url.includes("youtube.com") || v.url.includes("youtu.be")
        ? `<iframe src="${v.url.replace("watch?v=", "embed/")}" frameborder="0" allowfullscreen></iframe>`
        : `<video src="${v.url}" controls></video>`;

      const likeCount = stats[v._id] || 0;

      card.innerHTML = `
        ${media}
        <h4>${v.title}</h4>
        <p class="like-count">üëç ${likeCount} Likes</p>
        <button class="btn-danger" onclick="deleteVideo('${v._id}')">Delete</button>
      `;
      videoList.appendChild(card);
    });

    // üîÑ Poll like stats every 5s
    setInterval(async () => {
      try {
        const newStats = await fetch("/api/admin/video-stats", {
          headers: { Authorization: "Bearer " + token }
        }).then(res => res.json());

        videos.forEach(v => {
          const likeCount = newStats[v._id] || 0;
          const card = document.getElementById(`video-${v._id}`);
          if (card) {
            card.querySelector(".like-count").textContent = `üëç ${likeCount} Likes`;
          }
        });
      } catch (err) {
        console.error("Error refreshing like stats:", err);
      }
    }, 5000);

  } catch (err) {
    showToast("‚ùå Error loading videos: " + err.message, true);
  }
}


// Load users
async function loadUsers() {
  try {
    const usersRes = await fetch("/api/admin/users", {
      headers: { Authorization: "Bearer " + token }
    });
    const users = await usersRes.json();
    const userList = document.getElementById("user-list");
    const select = document.getElementById("chatUserSelect");
    userList.innerHTML = "";
    select.innerHTML = "<option value=''>-- Select User --</option>";

    users.forEach(u => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${u.email}</td>
        <td>${u.role}</td>
        <td><button class="btn-danger" onclick="deleteUser('${u._id}')">Remove</button></td>`;
      userList.appendChild(row);

      const opt = document.createElement("option");
      opt.value = u.email;
      opt.textContent = u.email;
      select.appendChild(opt);
    });
  } catch (err) {
    showToast("‚ùå Error loading users: " + err.message, true);
  }
}


  // ‚úÖ Chat
  async function loadChatMessages(userEmail) {
    if (!userEmail) return;

    try {
      const res = await fetch(`/api/chat/messages/${userEmail}`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) throw new Error("Failed to load messages");

      const messages = await res.json();

      // ‚úÖ Notify if new message from this user
      if (lastMessageCounts[userEmail] !== undefined && messages.length > lastMessageCounts[userEmail]) {
        if (selectedChatUser !== userEmail) {
          showToast(`üì© New message from ${userEmail}`);
        }
      }
      lastMessageCounts[userEmail] = messages.length;

      // ‚úÖ Render
      if (selectedChatUser === userEmail) {
        const messagesDiv = document.getElementById("chatMessages");
        messagesDiv.innerHTML = "";
        messages.forEach(msg => {
          const bubble = document.createElement("div");
          bubble.textContent = `${msg.sender}: ${msg.message}`;
          bubble.style.marginBottom = "8px";
          bubble.style.padding = "6px 10px";
          bubble.style.borderRadius = "8px";
          bubble.style.background = msg.sender === "admin" ? "#3498db" : "#2ecc71";
          bubble.style.color = "#fff";
          bubble.style.textAlign = msg.sender === "admin" ? "right" : "left";
          messagesDiv.appendChild(bubble);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    } catch (err) {
      console.error("Chat load error", err);
    }
  }

  async function sendAdminMessage() {
    const email = document.getElementById("chatUserSelect").value.trim();
    const msg = document.getElementById("adminMessageInput").value.trim();
    if (!email || !msg) return showToast("Please select a user and type a message.", true);

    try {
      const res = await fetch(`/api/chat/messages/${email}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || "Failed to send");
      showToast("‚úÖ Message sent");
      document.getElementById("adminMessageInput").value = "";
      loadChatMessages(email);
    } catch (err) {
      showToast("‚ùå " + err.message, true);
    }
  }

  document.getElementById("chatUserSelect").addEventListener("change", e => {
    selectedChatUser = e.target.value || null;
    if (selectedChatUser) loadChatMessages(selectedChatUser);
    else document.getElementById("chatMessages").innerHTML = "<p>No user selected.</p>";
  });

  // ‚úÖ Delete
  async function deleteVideo(id) {
    await fetch(`/api/admin/videos/${id}`, { method: "DELETE", headers: { Authorization: "Bearer " + token } });
    showToast("‚úÖ Video deleted");
    loadAdminData();
  }

  async function deleteUser(id) {
    await fetch(`/api/admin/users/${id}`, { method: "DELETE", headers: { Authorization: "Bearer " + token } });
    showToast("‚úÖ User removed");
    loadAdminData();
  }

  // ‚úÖ Polling every 5s for all users
  setInterval(async () => {
    const select = document.getElementById("chatUserSelect");
    Array.from(select.options).forEach(opt => {
      if (opt.value) loadChatMessages(opt.value);
    });
  }, 5000);

  // Init
  // loadAdminData();
  document.addEventListener("DOMContentLoaded", () => {
  loadVideos();
  loadUsers();
});

</script>

</body>
</html>
